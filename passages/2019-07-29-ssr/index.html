<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ssr服务端渲染 | 想飞的博客</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.9f5fedfb.css" as="style"><link rel="preload" href="/assets/js/app.66620904.js" as="script"><link rel="preload" href="/assets/js/2.22f6b1d1.js" as="script"><link rel="preload" href="/assets/js/31.9028f997.js" as="script"><link rel="preload" href="/assets/js/3.5e21b91e.js" as="script"><link rel="prefetch" href="/assets/js/10.8e29ffc8.js"><link rel="prefetch" href="/assets/js/11.2c274561.js"><link rel="prefetch" href="/assets/js/12.71c7899f.js"><link rel="prefetch" href="/assets/js/13.07e578d9.js"><link rel="prefetch" href="/assets/js/14.6002bb1e.js"><link rel="prefetch" href="/assets/js/15.6436defe.js"><link rel="prefetch" href="/assets/js/16.199e67df.js"><link rel="prefetch" href="/assets/js/17.5de884d9.js"><link rel="prefetch" href="/assets/js/18.79d42d7b.js"><link rel="prefetch" href="/assets/js/19.e176ec19.js"><link rel="prefetch" href="/assets/js/20.4cbea216.js"><link rel="prefetch" href="/assets/js/21.690fb409.js"><link rel="prefetch" href="/assets/js/22.ab6a9e8d.js"><link rel="prefetch" href="/assets/js/23.96e55113.js"><link rel="prefetch" href="/assets/js/24.ada615e3.js"><link rel="prefetch" href="/assets/js/25.faeb28c9.js"><link rel="prefetch" href="/assets/js/26.27579601.js"><link rel="prefetch" href="/assets/js/27.e8350cd0.js"><link rel="prefetch" href="/assets/js/28.63885741.js"><link rel="prefetch" href="/assets/js/29.fd0107e4.js"><link rel="prefetch" href="/assets/js/30.55202181.js"><link rel="prefetch" href="/assets/js/32.79821171.js"><link rel="prefetch" href="/assets/js/33.c990f409.js"><link rel="prefetch" href="/assets/js/34.4593a27f.js"><link rel="prefetch" href="/assets/js/35.171512bd.js"><link rel="prefetch" href="/assets/js/4.c7ccbd4c.js"><link rel="prefetch" href="/assets/js/5.b3597586.js"><link rel="prefetch" href="/assets/js/6.264b5b0b.js"><link rel="prefetch" href="/assets/js/7.5430b290.js"><link rel="prefetch" href="/assets/js/8.ad4bbf50.js"><link rel="prefetch" href="/assets/js/9.14f7ae1f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f5fedfb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">想飞的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">导航</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大前端" class="dropdown-title"><span class="title">大前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2019-07-09-js-context/" class="nav-link">JavaScript</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2019-07-10-tool-markdown/" class="nav-link">markdown语法</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-07-10-tool-git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-11-05-tool-nvm-mrm/" class="nav-link">nvm和nrm</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-08-04-travis-ci/" class="nav-link">Travis Ci</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="解决方案" class="dropdown-title"><span class="title">解决方案</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2019-07-11-solution-webpack-env/" class="nav-link">webpack打包上线环境配置</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-07-29-ssr/" class="nav-link router-link-exact-active router-link-active">ssr服务端渲染</a></li></ul></div></div><div class="nav-item"><a href="/hooks/introduction.html" class="nav-link">hooks</a></div><div class="nav-item"><a href="/webpack/introduction.html" class="nav-link">webpack</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随手记" class="dropdown-title"><span class="title">随手记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2019-08-11-wen/" class="nav-link">言摘文摘</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-08-11-yun/" class="nav-link">晚间乌云</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/happydxh/happydxh.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">导航</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大前端" class="dropdown-title"><span class="title">大前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2019-07-09-js-context/" class="nav-link">JavaScript</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2019-07-10-tool-markdown/" class="nav-link">markdown语法</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-07-10-tool-git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-11-05-tool-nvm-mrm/" class="nav-link">nvm和nrm</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-08-04-travis-ci/" class="nav-link">Travis Ci</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="解决方案" class="dropdown-title"><span class="title">解决方案</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2019-07-11-solution-webpack-env/" class="nav-link">webpack打包上线环境配置</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-07-29-ssr/" class="nav-link router-link-exact-active router-link-active">ssr服务端渲染</a></li></ul></div></div><div class="nav-item"><a href="/hooks/introduction.html" class="nav-link">hooks</a></div><div class="nav-item"><a href="/webpack/introduction.html" class="nav-link">webpack</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随手记" class="dropdown-title"><span class="title">随手记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2019-08-11-wen/" class="nav-link">言摘文摘</a></li><li class="dropdown-item"><!----> <a href="/passages/2019-08-11-yun/" class="nav-link">晚间乌云</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/happydxh/happydxh.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/passages/2019-07-11-solution-webpack-env/" class="sidebar-link">webpack打包上线环境配置</a></li><li><a href="/passages/2019-07-29-ssr/" class="active sidebar-link">ssr服务端渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#ssr-vs-csr-vs-同构" class="sidebar-link">SSR vs CSR vs 同构</a></li><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#服务端渲染" class="sidebar-link">服务端渲染</a></li><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#客户端渲染" class="sidebar-link">客户端渲染</a></li><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#react组件服务端渲染" class="sidebar-link">react组件服务端渲染</a></li><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#同构" class="sidebar-link">同构</a></li><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#同构路由" class="sidebar-link">同构路由</a></li><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#同构redux" class="sidebar-link">同构redux</a></li><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#异步数据获取" class="sidebar-link">异步数据获取</a></li><li class="sidebar-sub-header"><a href="/passages/2019-07-29-ssr/#数据的-脱水-和-注水" class="sidebar-link">数据的 脱水 和 注水</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>项目地址：<a href="https://github.com/happydxh/react-ssr" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="ssr-vs-csr-vs-同构"><a href="#ssr-vs-csr-vs-同构" class="header-anchor">#</a> SSR vs CSR vs 同构</h2> <p>首先我们先来了解三个概念</p> <blockquote><p>SSR - <code>服务端渲染</code>，指后端服务器直接返回html字符串，让浏览器显示<br>
CSR - <code>客户端渲染</code>，指使用js来渲染页面大部分内容，如react构建的<code>SPA</code>单页面应用<br>
同构 - <code>同构渲染</code>，指一套相同的代码在服务端执行一遍，然后在客户端又执行一遍</p></blockquote> <h2 id="服务端渲染"><a href="#服务端渲染" class="header-anchor">#</a> 服务端渲染</h2> <p>什么是服务端渲染，首先我们来看一个简单的列子，来直观的感受一下服务端渲染</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;hello&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;h1&gt;hello&lt;/h1&gt;
      &lt;p&gt;world&lt;/p&gt;
    &lt;/body&gt;
  &lt;/html&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'localhost:8888'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>启动之后打开localhost:8888可以看到页面显示了hello world。而且打开网页源代码可以看到</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这就是服务端渲染，服务端返回给浏览器一段字符串供浏览器显示，所有标签和内容都可以在源代码中查看到，供搜索引擎爬虫识别</p> <h2 id="客户端渲染"><a href="#客户端渲染" class="header-anchor">#</a> 客户端渲染</h2> <h4 id="什么是客户端渲染"><a href="#什么是客户端渲染" class="header-anchor">#</a> 什么是客户端渲染</h4> <p>我们使用create-react-app脚手架创建一个项目，然后启动他，在浏览器上右键查看源代码，我们可以看到index页面除了基本的页面结构，只有一个id为root的标签，并没有多于的DOM标签，那么我们看到的其他内容是从那里来的呢，很明显是下面script拉取的js代码来执行渲染的。</p> <h4 id="客户端渲染的弊端"><a href="#客户端渲染的弊端" class="header-anchor">#</a> 客户端渲染的弊端</h4> <ul><li>客户端渲染需要下载一堆js和css后才能渲染页面，首屏加载慢出现白屏问题</li> <li>对于SEO，完全无能为力，因为搜索引擎爬虫只认识html结构的内容，而不能识别JS代码内容。</li></ul> <blockquote><p>而客户端渲染的弊端恰恰就是服务端渲染的优势，ssr的出现就是为例解决客户端渲染的弊端</p></blockquote> <h2 id="react组件服务端渲染"><a href="#react组件服务端渲染" class="header-anchor">#</a> react组件服务端渲染</h2> <p>前面我们实现了一个简单的服务端渲染的例子，通过koa服务返会一段html字符串给浏览器，起一个抛砖引玉的作用，但我们真正要实现的是如何通过react进行服务端渲染</p> <p>首先写一个简单的react组件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Home.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>This is home page<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Home
</code></pre></div><p>有了一个react组件，接下来我们需要将组件转成html字符串，然后通过koa服务返回给浏览器</p> <p>服务端代码如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'./Home'</span><span class="token punctuation">;</span>
<span class="token comment">// 通过执行Home()你可以看到一个虚拟DOM</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 编译虚拟DOM的方法</span>
<span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Home <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;hello&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
    &lt;/body&gt;
  &lt;/html&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'localhost:8888'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如若我们直接node app.js执行上面服务，会发生错误，因为服务端node并不支持es6模块的引入写法，还有react、async等的写法都没有支持，所有我们需要使用webpackd对上述代码做一个简单的处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/polyfill'</span><span class="token punctuation">,</span> <span class="token string">'./app.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
      loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
      exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
      options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-react'</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          targets<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'last 2 versions'</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'build'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;react-ssr-koa&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack &amp;&amp; node build/bundle.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@babel/core&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.5.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@babel/polyfill&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.4.4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@babel/preset-env&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.5.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@babel/preset-react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.0.6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.38.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack-cli&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.3.6&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;koa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.7.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.8.6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;react-dom&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.8.6&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这是执行命令<code>npm run dev</code>打开<code>http://localhost:8888/</code>便可以看到react组件对应的页面内容，右键查看源代码也可以看到对应的标签内容</p> <h2 id="同构"><a href="#同构" class="header-anchor">#</a> 同构</h2> <p>上面我们虽然实现了react组件的服务端渲染，但却只是实现了页面内容的服务端渲染，页面的交互行为却并未生效</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>This is home page<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">+</span>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span>click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> Home
</code></pre></div><p>上面我们在react组件中新加了一个点击事件，重新运行，我们点击按钮，发现并没有起任何作用，这是因为react-dom/server的renderToString并没有做相关事件的处理，只是把虚拟DOM转成了真实的html字符串，我们可以打印一下renderToString返回content的内容</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>This is home page<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span>button<span class="token operator">&gt;</span>click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
</code></pre></div><p>可以看到，并没有事件绑定</p> <p>出现问题就要解决问题，要解决事件绑定的问题，就需要同构，同构我们在一开始就说过，所谓同构就是指一套相同的代码在服务端执行一遍，然后在客户端又执行一遍，服务端渲染完成页面结构，浏览器端渲染完成事件绑定</p> <p>而我们想要浏览器端再执行一遍react代码，唯一的方式就是让浏览器主动加载react代码文件，让js再执行一次渲染。我们对服务端的代码先做一点更改</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;hello&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
+     &lt;script src=&quot;/index.js&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到，我们在返回给浏览器中的字符串中，新加了一个script标签来加载js文件，这个js文件就是我们react项目中常见的打包的主文件</p> <p>接下来我们要做的就是打包如何得到这个文件，其实和我们平时写react单页工程是一样的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// client/index. js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDom <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'../containers/Home'</span><span class="token punctuation">;</span>

ReactDom<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Home <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>不同的是将ReactDOM.render()换成ReactDom.hydrate()混合服务端渲染</p> <p>然后我们使用webpack将该react项目进行打包，输入index.js文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.client.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clientConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./src/client/index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">'index.js'</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> clientConfig<span class="token punctuation">)</span>

<span class="token comment">// webpack.base.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
      loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
      exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
      options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-react'</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          targets<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'last 2 versions'</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// package.json的script部分</span>
<span class="token string">&quot;scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;dev&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;npm-run-all --parallel dev:**&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 同步执行 dev:build:server dev:build:client dev:start</span>
  <span class="token string">&quot;dev:build:server&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack --config webpack.server.js --watch&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 执行服务端配置并监听</span>
  <span class="token string">&quot;dev:build:client&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack --config webpack.client.js --watch&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 执行客户端配置并监听</span>
  <span class="token string">&quot;dev:start&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;nodemon --watch build --exec node \&quot;./build/bundle.js\&quot;&quot;</span> <span class="token comment">// 监听 build目录并执行node</span>
<span class="token punctuation">}</span>
</code></pre></div><p>打包的文件进入到public目录中，因为我们需要加载该目录中的index.js文件，所有我们需要将该目录设置成静态资源服务的目录</p> <p>完整的服务端代码如下</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token keyword">const</span> staticFile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'../containers/Home'</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 静态资源服务</span>
<span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">staticFile</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Home <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;hello&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
        &lt;script src=&quot;/index.js&quot;&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'localhost:8888'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>至此，我们就实现了同构，绑定事件完成</p> <h2 id="同构路由"><a href="#同构路由" class="header-anchor">#</a> 同构路由</h2> <p>完成了上面的简单同构之后，我们接来下继续在我们的项目中引入路由，首先是客户端，客户端路由的写法和我们平时写路由是一样的</p> <p>我们先新建一个list页面</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// containers/List.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      这里是list
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>新增一个router.js文件来处理路由</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'./containers/Home'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> List <span class="token keyword">from</span> <span class="token string">'./containers/List'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">'/'</span> exact component<span class="token operator">=</span><span class="token punctuation">{</span>Home<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Route<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">'/list'</span> exact component<span class="token operator">=</span><span class="token punctuation">{</span>List<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Route<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
</code></pre></div><p>然后修改一下我们客户端的主文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDom <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span>
<span class="token keyword">import</span> Routes <span class="token keyword">from</span> <span class="token string">'../router'</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>BrowserRouter<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>Routes<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>BrowserRouter<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

ReactDom<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这样客户端的路由便做好了，我们在Home页面中新增一个按钮跳转到List页面</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">go</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      props<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>This is home page<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span>click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">+</span>       <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> go <span class="token punctuation">}</span><span class="token operator">&gt;</span>toList<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> Home
</code></pre></div><p>点击toList按钮，我们如愿的跳转到了list，完成了路由跳转，但我们右键打开源代码查看，却发现</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>This is home page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>click<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>toList<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>源码还是home页面的代码，并没有改变，这不是我们希望看到的，这样将不利于list页面的seo</p> <p>所以我们还得继续对服务端的路由进行处理，让路由代码在服务端再执行一遍，实现同构</p> <p>服务端代码修改如下</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> staticFile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span> 
<span class="token operator">+</span> <span class="token keyword">import</span> Routes <span class="token keyword">from</span> <span class="token string">'../router'</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">staticFile</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 关键的，我们使用了StaticRouter</span>
—   <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Home <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token operator">+</span>   <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
<span class="token operator">+</span>     <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
<span class="token operator">+</span>        <span class="token punctuation">{</span>Routes<span class="token punctuation">}</span>
<span class="token operator">+</span>     <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span>
<span class="token operator">+</span>   <span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> 
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;hello&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
        &lt;script src=&quot;/index.js&quot;&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'localhost:8888'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这样当我们再次切换到list时，就能够看到list页面对应的源码了</p> <h2 id="同构redux"><a href="#同构redux" class="header-anchor">#</a> 同构redux</h2> <p>这一块，我们继续将redux引入我们的项目中，redux的概念我们不多说，快速的现在客户端将它搭建起来</p> <p>首先我们安装依赖包</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> react-redux redux redux-thunk -S
</code></pre></div><p>然后在创建一个redux目录,在里面放入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// rudex/home.redux.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>

<span class="token keyword">const</span> <span class="token constant">CHANGE_INFO</span> <span class="token operator">=</span> <span class="token string">'CHANGE_INFO'</span>

<span class="token keyword">const</span> initState <span class="token operator">=</span> <span class="token punctuation">{</span>
  info<span class="token punctuation">:</span> <span class="token string">'这里是主页'</span>
<span class="token punctuation">}</span>

<span class="token comment">// reducer</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CHANGE_INFO</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> info<span class="token punctuation">:</span> action<span class="token punctuation">.</span>info <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> state
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// action</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">changeInfo</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">CHANGE_INFO</span><span class="token punctuation">,</span> info <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 组合器 合并所有reducer 并且返回 </span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> combineReducers<span class="token punctuation">,</span> applyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">'redux-thunk'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> home <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./home.rudex'</span>

<span class="token keyword">const</span> reducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span> home <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 导出创建的store</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>然后将redux/index.js中的store分别引入到客户端和服务端中去</p> <p>客户端</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'../redux'</span>

<span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>BrowserRouter<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span>Routes<span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>BrowserRouter<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
</code></pre></div><p>服务端</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'../redux'</span>

<span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>Routes<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
</code></pre></div><p>两者引入方式相同，都是通过Provider引入，到这里同构中引入redux基本完成，但是这里还存在一个潜在的问题，就是上面<code>redux/index.js</code>中的<code>store</code>是直接导出的，这样在客户端引用的时候是不会出现问题，但是在服务端的代码是给所有用户使用的，这样会导致所有用户共用一个store</p> <p>对<code>redux/index.js</code>中做如下修改</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 导出创建的store</span>
<span class="token comment">// 这种写法在客户端可取，但在服务器端会导致所有用户共用了同一个状态</span>
<span class="token comment">// export default createStore(reducer, applyMiddleware(thunk))</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>修改以后，这时在客户端和服务端引入的store就是一个函数，我们把store函数执行就可以得到一个新的store</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
</code></pre></div><h2 id="异步数据获取"><a href="#异步数据获取" class="header-anchor">#</a> 异步数据获取</h2> <h4 id="客户端获取数据"><a href="#客户端获取数据" class="header-anchor">#</a> 客户端获取数据</h4> <p>我们在react单页运用开发中，经常会在生命周期<code>componentDidMount</code>中请求接口来获取服务端的数据，但是在服务端渲染中这样请求数据却会出现问题</p> <p>我们需要异步获取数据，首先对redux做一点修改，引入redux-thunk相关逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// redux/home.redux.js 修改</span>
<span class="token operator">+</span> <span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>

  <span class="token keyword">const</span> <span class="token constant">CHANGE_INFO</span> <span class="token operator">=</span> <span class="token string">'CHANGE_INFO'</span>
<span class="token operator">+</span> <span class="token keyword">const</span> <span class="token constant">CHANGE_LIST</span> <span class="token operator">=</span> <span class="token string">'CHANGE_LIST'</span>

  <span class="token keyword">const</span> initState <span class="token operator">=</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">:</span> <span class="token string">'这里是主页'</span><span class="token punctuation">,</span>
<span class="token operator">+</span>   list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// reducer</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">CHANGE_INFO</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> info<span class="token punctuation">:</span> action<span class="token punctuation">.</span>info <span class="token punctuation">}</span>
<span class="token operator">+</span>     <span class="token keyword">case</span> <span class="token constant">CHANGE_LIST</span><span class="token punctuation">:</span>
<span class="token operator">+</span>       <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> list<span class="token punctuation">:</span> action<span class="token punctuation">.</span>list <span class="token punctuation">}</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> state
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// action</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">changeInfo</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">CHANGE_INFO</span><span class="token punctuation">,</span> info <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">changeList</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>   <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">CHANGE_LIST</span><span class="token punctuation">,</span> list <span class="token punctuation">}</span>
<span class="token operator">+</span> <span class="token punctuation">}</span>

  <span class="token comment">// redux-thunk</span>
<span class="token operator">+</span> <span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getHomeList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span> <span class="token parameter">dispatch<span class="token punctuation">,</span> getState</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:9999/list'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>      <span class="token keyword">const</span> list <span class="token operator">=</span> res<span class="token punctuation">.</span>data
<span class="token operator">+</span>      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">changeList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span> <span class="token punctuation">}</span>
</code></pre></div><p>在修改home.redux.js文件后，我们看到我们新增了一个异步获取数据的方法<code>getHomeList</code>，它请求了一个接口，接口是我们在根目录下开起了另外一个koa服务模拟的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-cors'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  maxAge<span class="token punctuation">:</span> <span class="token number">3600</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'看书'</span><span class="token punctuation">,</span> <span class="token string">'写字'</span><span class="token punctuation">,</span> <span class="token string">'听歌'</span><span class="token punctuation">]</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 启动路由</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'localhost:9999'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后在package.json的<code>scripts</code>中新增启动服务命令</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token string">&quot;dev:server&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;nodemon server.js&quot;</span>
</code></pre></div><p>这样我们在使用npm run dev启动项目的时候，顺带也会将server.js的服务启动</p> <p>然后我们在Home组件的<code>componentDidMount</code>调用getHomeList，并将获取的数据循环渲染出来</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  props<span class="token punctuation">.</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到，接口请求成功，并且页面上的数据也渲染了出来，但当我们右键查看源代码时，却并没有发现相对应的标签，这是为什么呢</p> <p>让我们来分析一下户端和服务端的运行流程，浏览器执行请求时，服务端接收到请求，这时服务端的store是空的，并向浏览器端输出html模版，浏览器端接口html字符串并下载js执行，这是浏览器端的store也是空的，当执行到<code>componentDidMount</code>请求getHomeList后，浏览器端的store有了数据，但是服务器端的<code>componentDidMount</code>确始终不会执行，服务端的store依旧是空的，所有源代码不会出现我们想看到的标签</p> <p>接下来我们的任务就是让获取数据的操作在服务端执行，并在服务端渲染</p> <h4 id="服务端获取数据"><a href="#服务端获取数据" class="header-anchor">#</a> 服务端获取数据</h4> <p>要达到获取数据的操作在服务端执行，我们需要先将路由改造一下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// router.js</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'./containers/Home'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> List <span class="token keyword">from</span> <span class="token string">'./containers/List'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
    component<span class="token punctuation">:</span> Home<span class="token punctuation">,</span>
    exact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    loadData<span class="token punctuation">:</span> Home<span class="token punctuation">.</span>loadData<span class="token punctuation">,</span> <span class="token comment">// 服务端获取异步数据的函数</span>
    key<span class="token punctuation">:</span> <span class="token string">'home'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">'/list'</span><span class="token punctuation">,</span>
    component<span class="token punctuation">:</span> List<span class="token punctuation">,</span>
    exact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token string">'list'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>客户端和服务端引入路由的方式也需要相应的改变</p> <p>客户端</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> renderRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-config'</span>
<span class="token comment">// 引入react-router-config的renderRoutes函数来对路由的配置信息做解析渲染</span>
<span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>BrowserRouter<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Switch<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>
        <span class="token function">renderRoutes</span><span class="token punctuation">(</span>routeConfig<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>BrowserRouter<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
</code></pre></div><p>服务端</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> renderRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-config'</span>
<span class="token comment">// 引入react-router-config的renderRoutes函数来对路由的配置信息做解析渲染</span>
<span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Switch<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routeConfig<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
</code></pre></div><p>我们在router.js的路由配置数据中，配置了一个loadData函数，这个参数代表了在服务端获取数据的函数，现在我们的目标就是如何让这个函数在服务端执行，并且要针对不同路由组件匹配不用的loadData函数</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用matchRoutes用来匹配当前路由(支持多级路由)</span>
  <span class="token keyword">const</span> matchedRoutes <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routeConfig<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  matchedRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果这个路由对应的组件有loadData方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span>loadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 那么就执行一次, 并将store传进去</span>
      <span class="token comment">// loadData函数调用后需要返回Promise对象</span>
      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span>

  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Switch<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routeConfig<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;hello&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
      &lt;script&gt;
        window.context = {
          state: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        }
      &lt;/script&gt;
      &lt;script src=&quot;/index.js&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>经过上面的处理，我们就可以在组件中调用loadData函数了</p> <div class="language-js extra-class"><pre class="language-js"><code>Home<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样服务端渲染中异步获取数据就完成了，然而，解决了这个问题之后，另一个问题又来了</p> <h2 id="数据的-脱水-和-注水"><a href="#数据的-脱水-和-注水" class="header-anchor">#</a> 数据的 脱水 和 注水</h2> <p>如果我们将客户端<code>componentDidMount</code>中获取数据的代码注释掉会发现，现在页面中不会有数据，但是源码码中却有数据。这是为什么？</p> <p>我们来分析一下，源码中有数据，说明服务端中的store已经注入来数据，而客户端没有渲染出来，是因为服务端没有把数据同步给客户端，同时<code>componentDidMount</code>中请求接口的代码我们又注释掉了，这时客户端中的store依旧是空的</p> <p>那如何才能让这两个store的数据同步变化呢?</p> <p>解决这个问题的流程，其实就是数据的 <code>脱水</code> 和 <code>注水</code></p> <p>在服务端，拿到数据更新store后，在服务器端响应页面HTML的时候，将store中的数据一并传递给浏览器，这叫<code>脱水</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;hello&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
+     &lt;script&gt;
+       window.context = {
+         state: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
+       }
+     &lt;/script&gt;
      &lt;script src=&quot;/index.js&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>然后在客户端，接收到服务端发送过来的页面后，就可以在<code>window</code>对象上获取store中的数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// redux/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getClientStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从服务器端输出的页面上拿到脱水的数据</span>
  <span class="token keyword">const</span> defaultState <span class="token operator">=</span> window<span class="token punctuation">.</span>context <span class="token operator">?</span> window<span class="token punctuation">.</span>context<span class="token punctuation">.</span>state <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 当做 store的初始数据（即注水）</span>
  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> defaultState<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这里数据的 脱水 和 注水也已经完成，但是还有一点小问题，就当服务端获取数据，并将数据传给客户端后，客户端其实是不需要再进行数据请求的，这是我们做一些小处理，便可以规避此问题</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果props.list中已经有数据了，我们就不再请求</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    props<span class="token punctuation">.</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">8/5/2019, 12:42:46 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/passages/2019-07-11-solution-webpack-env/" class="prev">webpack打包上线环境配置</a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.66620904.js" defer></script><script src="/assets/js/2.22f6b1d1.js" defer></script><script src="/assets/js/31.9028f997.js" defer></script><script src="/assets/js/3.5e21b91e.js" defer></script>
  </body>
</html>
